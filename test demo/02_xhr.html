<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>使用XHR封装ajax请求参数</title>
</head>

<body>
<div>
  <button onclick="testGet()">GET请求</button>
  <button onclick="testPost()">POST请求</button>
  <button onclick="testPut()">PUT请求</button>
  <button onclick="testDelete()">DELETE请求</button>
</div>
<!--
  1. 函数的返回值为 promise, 成功的结果为 response, 异常的结果为 error
  2. 能处理多种类型的请求: GET/POST/PUT/DELETE
  3. 函数的参数为一个配置对象
      {
        url: '', // 请求地址
        method: '', // 请求方式 GET/POST/PUT/DELETE
        params: {}, // GET/DELETE 请求的 query 参数
        data: {}, // POST 或 DELETE 请求的请求体参数
      }
  4. 响应 json数据自动解析为对象或者数组
-->
<script>
  function axios({
                   url,
                   method = "GET",
                   params = {},
                   data = {}

                 }) {
    //函数返回一个promise对象
    return new Promise((resolve, reject) => {
      //处理method请求(转大写)
      method = method.toUpperCase();

      //处理query参数(拼接到url上)    id=1&xxx=abc
      /*
        {
          id: 1,
          xxx: 'abc'
        }
      */
      let queryString = '';
      Object.keys(params).forEach((key) => {
        queryString += `${key}=${params[key]}&`
        // console.log(queryString);
      });
      if (queryString) {
        //去除后面的&
        queryString = queryString.substring(0, queryString.length - 1);
        url += "?" + queryString;
      }
      //1.执行异步ajax请求
      //创建xhr对象
      const request = new XMLHttpRequest();
      //打开连接(初始化请求，还没有发送请求)
      request.open(method, url, true);
      //发送请求
      /* request.onreadystatechange = function () {

      } */
      if (method === "GET" || method === "DELETE") {
        request.send();
      } else if (method === "POST" || method === 'PUT') {
        //告诉服务器 请求的具体数据格式是JSON格式
        request.setRequestHeader("Content-Type", "application/json;chraset=UTF-8")
        request.send(JSON.stringify(data));   //发送JSON格式的请求参数
      }
      //绑定状态改变监听  放在前面
      // 也可以 放在后面也可以 放在前面代表 先准备监听  在发送数据  放在后面表示 先发送数据 在发送数据后立即执行监听
      request.onreadystatechange = function () {
        //如果请求没有完成,直接结束
        if (request.readyState != 4) {
          return;
        }
        //如果响应状态码在[200,299)之间代表成功 否则失败
        const {status, statusText} = request;
        if (Math.floor(status / 100) === 2) {
          // if (status >= 200 && status < 300) {
          //  准备结果数据对象response
          const response = {
            data: JSON.parse(request.response),
            status,
            statusText
          };
          resolve(response);
        } else {
          reject(new Error('request error status is ' + status));
        }
      }
      //2.1如果请求成功  调用resolve()
      //2.2如果请求失败  调用reject()
    });
  }

  //get请求
  function testGet() {
    axios({
      // url: 'http://localHost:3000/posts',
      url: 'http://localHost:3000/posts',
      method: 'GET',
      params: {
        id: 1,
        xxx: 'abc'
      }
    }).then(
            response => {
              console.log(response);
            },
            error => {
              alert(error.message)
            }
    )
  };

  //POST请求  想服务器端 保存数据 或者添加数据
  function testPost() {
    axios({
      url: 'http://localHost:3000/posts',
      method: 'POST',
      data: {
        "title": "json-server---xdd",
        "author": "typicode---asd"
      }
    }).then(
            response => {
              console.log(response);
            },
            error => {
              alert(error.message);
            })
  };

  //PUT请求  服务器端更新数据
  function testPut() {
    axios({
      url: 'http://localHost:3000/posts/1',
      method: 'put',
      data: {
        "title": "json-server+++xdd",
        "author": "type-code+++asd"
      }
    }).then(
            response => {
              console.log(response);
            },
            error => {
              alert(error.message);
            })
  };

  //DELETE  服务器端 删除数据
  function testDelete() {
    axios({
      url: 'http://localHost:3000/posts/2',
      method: 'put',
    }).then(
            response => {
              console.log(response);
            },
            error => {
              alert(error.message);
            })
  };
</script>
</body>
</html>